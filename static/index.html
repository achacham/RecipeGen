<!--
 ============================================================================
  RecipeGen™ - AI-Powered Culinary Video & Recipe Generation Platform
 ============================================================================
  
  Version: 3.0 (Culinary Cockpit Interface)
  Last Updated: August 2025

  © Copyright By Abraham Chachamovits
  RecipeGen™ is a trademark of Abraham Chachamovits
  
  OVERVIEW:
  RecipeGen transforms ingredient selection into personalized cooking videos
  and recipes using advanced AI. Features a sophisticated "culinary cockpit" 
  interface with no-scroll viewport design and dual ingredient selection modes.
  Built with 4D cascade logic and business model protection.
  
  KEY FEATURES:
  • Culinary cockpit interface - everything visible without scrolling
  • Dual ingredient selection: natural language chat + structured dialog
  • Dynamic ingredient loading from comprehensive JSON database
  • Business-defined dish types and dynamic cuisine population
  • Ingredient confirmation system for user trust
  • Protected chat that redirects recipe requests to paid generation
  • Real-time ingredient selection with visual feedback
  • $2.99 pay-per-recipe business model with video generation
  
  TECHNICAL ARCHITECTURE:
  • Frontend: Vanilla JavaScript with CSS3 (no frameworks)
  • Responsive design with fixed viewport (100vh, no scrolling)
  • Backend: Flask (Python) with SQLite
  • Dynamic data loading from ingredients.json
  • Video Generation: KIE AI API
  • Recipe Sources: Local DB + Spoonacular + TheMealDB
  • 4D Cascade: Local → APIs → Sister Cuisines → Essential
  
  INTERFACE DESIGN:
  • Left Panel: Recipe creation controls and chat interface
  • Right Panel: Information and features display
  • Modal-based ingredient selection with categorization
  • Business model protection preventing free recipe disclosure
  
  PHILOSOPHY:
  Built with 1980s engineering principles - reliable, modular, honest.
  No hardcoding. No false promises. Always delivers value.
  
  Created with pen, paper, and night-breeze programming wisdom.
 ============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RecipeGen - Premium Culinary Experience</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff6b6b;
            --primary-dark: #ff5252;
            --secondary: #4ecdc4;
            --accent: #45b7d1;
            --success: #96ceb4;
            --warning: #feca57;
            --purple: #a29bfe;
            --pink: #fd79a8;
            --orange: #fdcb6e;
            --dark: #2d3436;
            --gray: #636e72;
            --light: #ddd;
            --white: #ffffff;
        }

        .trademark {
            font-size: 0.5em;
            vertical-align: super;
            margin-left: 1px;
            opacity: 0.8;
        }

        /* VIEWPORT STRUCTURE FIX - Force 100vh containment */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            overflow: hidden; /* Critical: No scrolling anywhere */
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column; /* Header + Container stack */
        }

        /* Header - Fixed height */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem; /* Reduced from 1.5rem */
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0; /* Don't compress */
            height: 80px; /* Fixed height instead of content-based */
            display: flex;
            align-items: center;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo {
            font-size: 2.80rem; /* Increased 10% from 2.4rem */
            font-weight: 800;
            transition: all 0.6s ease;
            cursor: pointer;
            display: inline-block;
        }

        .logo-text {
            font-family: inherit; /* Use Poppins from body */
            font-weight: 700; /* Very bold weight */
            background: linear-gradient(135deg, var(--primary) 0%, var(--pink) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

 
        .nav {
            display: flex;
            gap: 1.5rem; /* Reduced from 2rem */
        }

        .nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            font-size: 0.9rem;
        }

        .nav a::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .nav a:hover::before {
            left: 100%;
        }

        .nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* Container - Takes remaining viewport space */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem; /* Reduced from 2rem */
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 1rem; /* Reduced from 2rem */
            flex: 1; /* Takes all remaining space after header */
            height: calc(100vh - 80px); /* Exact calculation */
            overflow: hidden; /* No container scrolling */
            box-sizing: border-box;
            width: 100%;
        }

        /* Left Panel - Fixed height, internal scrolling if needed */
        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 1.5rem; /* Reduced from 2.5rem */
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            height: 100%; /* Fill container height */
            overflow: hidden; /* No scrolling in cockpit */
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 1.5rem; /* Reduced from 2rem */
            font-weight: 700;
            margin-bottom: 1rem; /* Reduced from 2rem */
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
        }

        /* Form Styling */
        .recipe-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Reduced from 2rem */
            flex: 1;
        }

        .form-group {
            position: relative;
            flex-shrink: 1;
        }

        .form-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem; /* Reduced from 1rem */
            margin-bottom: 0.5rem; /* Reduced from 0.75rem */
            display: block;
            letter-spacing: 1px;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem 1rem; /* Reduced padding */
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 15px;
            font-size: 0.9rem; /* Reduced from 1rem */
            font-weight: 500;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }

        /* Select Ingredients Button */
        .select-ingredients-btn {
            background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
            box-shadow: 0 10px 25px rgba(69, 183, 209, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }

        .select-ingredients-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(69, 183, 209, 0.4);
        }

        /* Chat Container - Calculate exact height */
        .chat-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
            height: 170px;
            transition: all 0.3s ease;
        }

        .chat-container:focus-within {
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.15),
                0 0 0 3px rgba(255, 107, 107, 0.3);
            transform: translateY(-2px);
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--orange) 100%);
            padding: 0.25rem 0.75rem; /* Much more conservative padding */
            display: flex;
            align-items: center;
            gap: 0.75rem; /* Reduced gap */
            color: white;
            flex-shrink: 0;
        }

        .chat-icon {
            width: 28px; /* Smaller icon */
            height: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem; /* Smaller font */
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .chat-title {
            font-weight: 600;
            font-size: 0.9rem; /* Smaller title */
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            /* CRITICAL: Without this min-height, flex shrinks message area too small and vertical centering fails. 
            70px ensures proper centering within 170px container. */
            min-height: 70px; /* Ensure minimum space for centering */
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 10px;
        }

        .message {
            margin-bottom: 1rem; /* Reduced from 1.5rem */
            animation: messageSlide 0.4s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-content {
            max-width: 85%;
            padding: 0.75rem 1rem; /* Reduced padding */
            border-radius: 20px;
            font-size: 0.85rem; /* Reduced from 0.95rem */
            line-height: 1.5; /* Reduced from 1.6 */
            position: relative;
        }

        .message.user {
            display: flex;
            justify-content: flex-end;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary) 0%, var(--pink) 100%);
            color: white;
            border-bottom-right-radius: 5px;
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .message.bot {
            display: flex;
            justify-content: flex-start;
        }

        .message.bot .message-content {
            background: linear-gradient(135deg, var(--white) 0%, rgba(248, 249, 250, 0.9) 100%);
            color: var(--dark);
            border-bottom-left-radius: 5px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem; /* Reduced padding */
            background: linear-gradient(135deg, var(--white) 0%, rgba(248, 249, 250, 0.9) 100%);
            border-radius: 20px;
            border-bottom-left-radius: 5px;
            max-width: 85%;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            animation: messageSlide 0.4s ease;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px; /* Reduced from 8px */
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .chat-input-container {
            padding: 1rem; /* Reduced from 1.5rem */
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            gap: 0.75rem; /* Reduced from 1rem */
            align-items: end;
            flex-shrink: 0; /* Don't compress */
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem 1rem; /* Reduced padding */
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 15px;
            font-size: 0.85rem; /* Reduced from 0.95rem */
            resize: none;
            min-height: 40px; /* Reduced from 50px */
            max-height: 80px; /* Reduced from 120px */
            transition: all 0.3s ease;
            font-family: inherit;
            background: rgba(255, 255, 255, 0.9);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.2);
        }

        .chat-input::placeholder {
            color: var(--gray);
            opacity: 0.7;
        }

        .chat-send-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--pink) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1rem; /* Reduced padding */
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px; /* Reduced from 60px */
            box-shadow: 0 10px 25px rgba(255, 107, 107, 0.3);
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(255, 107, 107, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Dietary Tags */
        .dietary-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem; /* Reduced from 0.75rem */
        }

        .dietary-tag {
            padding: 0.5rem 1rem; /* Reduced padding */
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.8) 100%);
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 25px;
            font-size: 0.8rem; /* Reduced from 0.9rem */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dietary-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .dietary-tag:hover::before,
        .dietary-tag.active::before {
            left: 0;
        }

        .dietary-tag:hover,
        .dietary-tag.active {
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        /* Generate Button */
        .generate-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 1rem 1.5rem; /* Reduced padding */
            border-radius: 15px;
            font-size: 1rem; /* Reduced from 1.1rem */
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 35px rgba(150, 206, 180, 0.4);
            margin-top: 0.25rem;
            letter-spacing: 1px;
            flex-shrink: 0;
        }

        .generate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(150, 206, 180, 0.5);
        }

        .generate-btn:active {
            transform: translateY(-1px);
        }

        /* Ingredient Modal */
        .ingredient-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .ingredient-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 2rem;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
        }

        .ingredient-tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .ingredient-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0 0 1rem 0;
            border-bottom: 2px solid rgba(255, 107, 107, 0.1);
            flex-shrink: 0;
        }

        .ingredient-tab {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.7);
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            white-space: nowrap;
        }

        .ingredient-tab.active {
            background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
            color: white;
            border-color: var(--accent);
        }

        .ingredient-tab:hover:not(.active) {
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
        }

        .ingredient-tab-badge {
            background: var(--primary);
            color: white;
            border-radius: 12px;
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            margin-left: 0.5rem;
            font-weight: 600;
        }

        .ingredient-tab.active .ingredient-tab-badge {
            background: rgba(255, 255, 255, 0.3);
        }

        .ingredient-tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem 0;
            min-height: 300px;
            max-height: 300px;
        }

        .tab-category {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            padding: 1rem;
            border: 1px solid rgba(255, 107, 107, 0.1);
            margin-bottom: 1rem;
        }

        .tab-category-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ingredient-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .ingredient-item {
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(255, 107, 107, 0.2);
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .ingredient-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
            transition: left 0.3s ease;
            z-index: -1;
        }

        .ingredient-item:hover::before,
        .ingredient-item.selected::before {
            left: 0;
        }

        .ingredient-item:hover,
        .ingredient-item.selected {
            color: white;
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(69, 183, 209, 0.3);
        }

        .modal-footer {
            margin-top: 1rem; /* Reduced from 2rem - brings buttons up */
            display: flex;
            justify-content: center; /* Changed from space-between - centers buttons */
            gap: 1rem;
            padding-bottom: 1rem; /* Add padding to prevent cutoff */
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, var(--accent) 0%, var(--secondary) 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(69, 183, 209, 0.3);
        }

        .modal-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(69, 183, 209, 0.4);
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.8);
            color: var(--gray);
            border: 2px solid rgba(255, 107, 107, 0.2);
        }

        .modal-btn.secondary:hover {
            background: rgba(255, 107, 107, 0.1);
            color: var(--primary);
        }

        /* Right Panel - Fixed height */
        .right-panel {
            display: flex;
            flex-direction: column;
            height: 100%; /* Fill container height */
            overflow: hidden;
        }

        /* Info card takes remaining space */
        .info-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 2rem; /* Reduced from 3rem */
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            flex: 1; /* Take remaining space */
            overflow-y: auto; /* Scroll if needed */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .info-title {
            font-size: 2rem; /* Reduced from 2.5rem */
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .info-features {
            display: flex;
            justify-content: space-around;
            margin-top: 1.5rem; /* Reduced from 2rem */
            flex-wrap: wrap;
            gap: 1rem;
        }

        .feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 15px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8) 0%, rgba(248, 249, 250, 0.6) 100%);
            transition: all 0.3s ease;
        }

        .feature:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 1.5rem; /* Reduced from 2rem */
            margin-bottom: 0.5rem;
        }

        .feature-text {
            font-size: 0.8rem; /* Reduced from 0.9rem */
            font-weight: 500;
            color: var(--gray);
        }

        .chef-option:hover {
            border-color: var(--primary) !important;
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        /* Responsive - Stack on mobile but still no scrolling */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                height: calc(100vh - 80px);
                gap: 0.5rem;
            }
            
            .chat-container {
                height: 180px; /* Smaller on mobile */
            }

            .info-features {
                justify-content: center;
            }

            .nav {
                gap: 1rem;
            }

            .nav a {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
                height: 70px;
            }

            .container {
                height: calc(100vh - 70px);
                padding: 0.5rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .nav {
                gap: 0.5rem;
            }

            .chat-container {
                height: 200px;
            }

            .info-title {
                font-size: 1.5rem;
            }

            .modal-content {
                margin: 1rem;
                max-height: 90vh;
            }

            .ingredient-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

/* Chef Hat Trademark Enhancement */
.chef-hat-tm {
    font-size: 0.60em;
    display: inline-block;
    margin-left: -4px; /* Even closer to title (was -2px) */
    vertical-align: super;
    position: relative;
    top: -0.1em; /* Lower position (was -0.3em) */
    animation: chefPulse 3s ease-in-out infinite;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
}

/* Subtle chef hat pulse animation */
@keyframes chefPulse {
    0%, 100% { 
        transform: scale(1);
        opacity: 0.8;
    }
    50% { 
        transform: scale(1.2);
        opacity: 1;
    }
}

/* Hover effect for interactivity */
.logo:hover .chef-hat-tm {
    animation: chefFlicker 0.8s ease-in-out;
    transform: scale(1.15);
}

@keyframes chefFlicker {
    0%, 100% { opacity: 1; }
    25% { opacity: 0.7; }
    75% { opacity: 1; }
}

    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo" id="dynamicLogo">
                <span class="logo-text">RecipeGen</span><span class="chef-hat-tm">👨‍🍳</span><span class="trademark">™</span>
            </div>
            <nav class="nav">
                <a href="#"><i class="fas fa-home"></i> Home</a>
                <a href="#"><i class="fas fa-book"></i> Recipes</a>
                <a href="#"><i class="fas fa-info-circle"></i> About</a>
                <a href="#"><i class="fas fa-envelope"></i> Contact</a>
            </nav>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <h2 class="panel-title"><i class="fas fa-magic"></i> Create Your Recipe</h2>
            
            <form class="recipe-form">
                <!-- 1. Cuisine -->
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-globe"></i> Cuisine</label>
                    <select class="form-select" id="cuisineSelect">
                        <option value="">Choose cuisine...</option>
                        <!-- Will be populated from ingredients.json -->
                    </select>
                </div>

                <!-- 2. Dish Type -->
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-utensils"></i> Dish Type</label>
                    <select class="form-select" id="dishTypeSelect">
                        <option value="">Choose dish type...</option>
                        <!-- Will be populated from ingredients.json -->
                    </select>
                </div>

                <!-- 3. Dietary Preferences -->
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-leaf"></i> Dietary Preferences</label>
                    <div class="dietary-tags">
                        <div class="dietary-tag">🌱 Vegetarian</div>
                        <div class="dietary-tag">🥛 Dairy-Free</div>
                        <div class="dietary-tag">🌾 Gluten-Free</div>
                        <div class="dietary-tag">✡️ Kosher</div>
                        <div class="dietary-tag">🌶️ Spicy</div>
                        <div class="dietary-tag">⚡ Quick (30min)</div>
                    </div>
                </div>

                <!-- 4. Ingredients + Select Ingredients -->
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-carrot"></i> Ingredients</label>
                    <button type="button" class="select-ingredients-btn" id="selectIngredientsBtn">
                        <i class="fas fa-list"></i> Select Ingredients
                    </button>
                </div>

                <!-- 5. Generate Recipe -->
                <button type="button" class="generate-btn">
                    <i class="fas fa-magic"></i> Generate Recipe
                </button>

                <!-- 6. Chat with RecipeGen -->
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-comments"></i> What would you like to cook?</label>
                    <div class="chat-container">
                        <div class="chat-header">
                            <div class="chat-icon">🍽️</div>
                            <div class="chat-title">Chat with RecipeGen</div>
                        </div>
                        <div class="chat-messages" id="chatMessages">
                            <div class="message bot">
                                <div class="message-content">
                                     Hi! I'm your culinary assistant. What would you like to cook today?
                                </div>
                            </div>
                        </div>
                        <div class="chat-input-container">
                            <textarea class="chat-input" id="chatInput" 
                                      placeholder="What would you like to cook?"
                                      rows="1"></textarea>
                            <button class="chat-send-btn" id="chatSendBtn">
                                <i class="fas fa-paper-plane" id="sendIcon"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="info-card">
                <h3 class="info-title">Ready to Create Something Amazing?</h3>
                <p style="font-size: 1rem; color: var(--gray); margin-bottom: 1.5rem;">
                    Experience the future of cooking with our AI-powered recipe generation and premium video content.
                </p>
                
                <div class="info-features">
                    <div class="feature">
                        <div class="feature-icon">🔍</div>
                        <div class="feature-text">8,048+ recipes available</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">👨‍🍳</div>
                        <div class="feature-text">Our Kitchen always ready</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">🌍</div>
                        <div class="feature-text">Sister cuisine intelligence</div>
                    </div>
                    <div class="feature">
                        <div class="feature-icon">🎬</div>
                        <div class="feature-text">Premium video content</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredient Selection Modal -->
    <div class="ingredient-modal" id="ingredientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-carrot"></i> Select Ingredients</h3>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="ingredient-tabs-container">
                <div class="ingredient-tabs" id="ingredientTabs">
                    <!-- Tabs will be populated by JavaScript -->
                </div>
                <div class="ingredient-tab-content" id="ingredientTabContent">
                    <!-- Current tab content will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="clearSelection">Clear All</button>
                <button class="modal-btn primary" id="confirmSelection">Confirm Selection</button>
            </div>
        </div>
    </div>

    <!-- Chef Selection Modal -->
    <div id="chefSelectionModal" class="ingredient-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-chef-hat"></i> Choose Your Chef</h3>
                <button class="modal-close" id="chefModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Traditional Cook -->
                <div class="chef-option" onclick="selectChef('traditional')" style="cursor: pointer; padding: 1.5rem; border: 2px solid #ddd; border-radius: 15px; text-align: center; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent), var(--secondary)); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                        👨‍🍳
                    </div>
                    <h4 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--dark);">Traditional Cook</h4>
                    <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 1rem;">Classic recipes from our database and verified APIs</p>
                    <div style="font-size: 0.8rem; color: var(--gray); line-height: 1.4;">
                        • Authentic cuisines<br>
                        • Verified recipes<br>
                        • Traditional methods
                    </div>
                </div>
                
                <!-- Our Kitchen -->
                <div class="chef-option" onclick="selectChef('ai')" style="cursor: pointer; padding: 1.5rem; border: 2px solid #ddd; border-radius: 15px; text-align: center; transition: all 0.3s ease; background: rgba(255, 255, 255, 0.9);">
                    <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--pink)); border-radius: 50%; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                        🤖
                    </div>
                    <h4 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 0.5rem; color: var(--dark);">Our Kitchen</h4>
                    <p style="font-size: 0.9rem; color: var(--gray); margin-bottom: 1rem;">Creative RecipeGen fusion recipes</p>
                    <div style="font-size: 0.8rem; color: var(--gray); line-height: 1.4;">
                        • Innovative combinations<br>
                        • Custom creations<br>
                        • Fusion techniques
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Kosher/Dietary Validation Modal -->
    <div id="kosherModal"
        class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full border-2 border-green-700">
        <div id="kosherModalTitle" class="text-2xl font-bold text-green-800 mb-2"></div>
        <div id="kosherModalMsg" class="text-gray-700 whitespace-pre-line mb-6"></div>
        <button id="closeKosherModal"
                class="bg-green-700 text-white px-5 py-2 rounded shadow hover:bg-green-800 w-full font-bold text-lg">
          OK
        </button>
      </div>
    </div>



    <script>
        // Chat functionality - CLEAN, NO HARDCODING
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const sendIcon = document.getElementById('sendIcon');

        // Ingredient selection variables
        const ingredientModal = document.getElementById('ingredientModal');
        const selectIngredientsBtn = document.getElementById('selectIngredientsBtn');
        const modalClose = document.getElementById('modalClose');
        const clearSelection = document.getElementById('clearSelection');
        const confirmSelection = document.getElementById('confirmSelection');
        const ingredientCategories = document.getElementById('ingredientCategories');
        
        let selectedIngredients = [];
        let ingredientsData = {};

        // Dietary validation functions
        function showKosherModal(title, msg) {
            document.getElementById("kosherModalTitle").textContent = title;
            const content = Array.isArray(msg)
                ? msg.map(e => `<div>- ${e}</div>`).join("")
                : msg;
            document.getElementById("kosherModalMsg").innerHTML = content;
            document.getElementById("kosherModal").classList.remove("hidden");
        }

        async function validateCurrentSelections() {
            // Debug
            console.log('Validation called with conflicts:', window.activeConflicts);
            //
            const selectedDietaryTags = Array.from(document.querySelectorAll('.dietary-tag.active'))
                .map(tag => tag.textContent.trim().toLowerCase());
            
            if (selectedDietaryTags.length === 0 || selectedIngredients.length === 0) {
                return; // Nothing to validate
            }
            
            // Check for persistent conflicts from previous "Keep Anyway" decisions
            if (window.activeConflicts && Object.keys(window.activeConflicts).length > 0) {
                let stillConflicted = [];
                
                // Check each dietary type for persistent conflicts
                Object.keys(window.activeConflicts).forEach(dietaryType => {
                    const conflicts = window.activeConflicts[dietaryType];
                    conflicts.forEach(conflict => {
                        if (conflict.slug && selectedIngredients.some(ingredient => {
                            const ing = ingredientsData.find(item => item.name === ingredient);
                            return ing && ing.slug === conflict.slug;
                        })) {
                            stillConflicted.push(conflict);
                        }
                    });
                });
                
                if (stillConflicted.length > 0) {
                    // Collect the ingredient names from the conflicts
                    const stillConflictedIngredients = stillConflicted
                        .filter(c => c.name)
                        .map(c => c.name);
                    
                    const persistentMessage = stillConflicted.map(c => c.error).join('\n') + 
                        '\n\n(These ingredients remain in your selection)';
                    showEnhancedKosherModal("⚠️ Ongoing Dietary Conflict", persistentMessage, stillConflictedIngredients);
                    return; // Skip new validation since we're showing persistent conflicts
                } else {
                    // Conflicts resolved, clear them
                    window.activeConflicts = {};
                }
            }
            
            // Build validation modes array
            const modes = [];
            if (selectedDietaryTags.some(tag => tag.includes('vegetarian'))) modes.push('vegetarian');
            if (selectedDietaryTags.some(tag => tag.includes('gluten-free'))) modes.push('gluten-free');
            if (selectedDietaryTags.some(tag => tag.includes('dairy-free'))) modes.push('dairy_free');
            
            const cuisine = document.getElementById('cuisineSelect').value;
            if (cuisine === 'jewish') modes.push('jewish');
            
            if (modes.length === 0) return;
            
            // Call validation endpoint with multiple modes
            try {
                const response = await fetch('/validate_ingredients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ingredients: selectedIngredients.map(name => {
                            const ingredient = ingredientsData.find(ing => ing.name === name);
                            return ingredient ? ingredient.slug : name.toLowerCase().replace(/\s+/g, '-');
                        }),
                        modes: modes
                    })
                });
                
                const validation = await response.json();
                
                if (validation.problems && validation.problems.length > 0) {
                    // Group conflicts by dietary type for better organization
                    const conflictsByType = {};
                    const conflictingIngredients = [];
                    
                    // Process and group conflicts
                    validation.problems.forEach(p => {
                        // Determine conflict type from error message
                        let conflictType = 'general';
                        if (p.error.includes('vegetarian')) conflictType = 'vegetarian';
                        else if (p.error.includes('gluten')) conflictType = 'gluten_free';
                        else if (p.error.includes('dairy')) conflictType = 'dairy_free';
                        else if (p.error.includes('kosher') || p.error.includes('Jewish')) conflictType = 'kosher';
                        
                        if (!conflictsByType[conflictType]) {
                            conflictsByType[conflictType] = [];
                        }
                        
                        if (p.slug) {
                            const conflictingItem = selectedIngredients.find(ing => {
                                const ingredient = ingredientsData.find(item => item.name === ing);
                                return ingredient ? ingredient.slug === p.slug : false;
                            });
                            if (conflictingItem) {
                                conflictingIngredients.push(conflictingItem);
                                conflictsByType[conflictType].push({
                                    name: conflictingItem,
                                    slug: p.slug,
                                    error: p.error.replace(/^- /, '') + '!'
                                });
                            }
                        } else {
                            // Non-ingredient-specific errors (like mixing violations)
                            conflictsByType[conflictType].push({
                                error: p.error.replace(/^- /, '') + '!'
                            });
                        }
                    });
                    
                    // Auto-deselect conflicting ingredients from both array AND visual interface
                    validation.problems.forEach(p => {
                        if (p.slug) {
                            // Find the ingredient name being removed
                            const removedIngredientName = selectedIngredients.find(ing => {
                                const ingredient = ingredientsData.find(item => item.name === ing);
                                return ingredient ? ingredient.slug === p.slug : false;
                            });
                            
                            // Remove from array
                            selectedIngredients = selectedIngredients.filter(ing => {
                                const ingredient = ingredientsData.find(item => item.name === ing);
                                return ingredient ? ingredient.slug !== p.slug : true;
                            });
                            
                            // Remove visual selection from modal
                            if (removedIngredientName) {
                                const ingredientItems = document.querySelectorAll(`.ingredient-item[data-ingredient="${removedIngredientName}"]`);
                                ingredientItems.forEach(item => {
                                    item.classList.remove('selected');
                                });
                            }
                        }
                    });
                    updateTabBadges();
                    

                    // Build a cleaner message from grouped conflicts
                    let enhancedMessage = '';
                    let conflictCount = 0;

                    // For now, only vegetarian is implemented
                    if (conflictsByType.vegetarian && conflictsByType.vegetarian.length > 0) {
                        enhancedMessage += '🌱 Vegetarian conflicts:\n';
                        conflictsByType.vegetarian.forEach(conflict => {
                            if (conflict.name) {
                                enhancedMessage += `• ${conflict.name}\n`;
                                conflictCount++;
                            } else {
                                // General vegetarian message without specific ingredient
                                enhancedMessage += `• ${conflict.error}\n`;
                            }
                        });
                    }

                    // Add removed items note if any
                    if (conflictingIngredients.length > 0) {
                        enhancedMessage += `\n(${conflictCount} item${conflictCount > 1 ? 's' : ''} temporarily removed - click 'Keep Anyway' to restore all)`;
                    }

                    // Store conflicts in grouped format for future use
                    window.activeConflicts = conflictsByType;

                    // Debug to see structure
                    console.log('Grouped conflicts:', window.activeConflicts);

                    showEnhancedKosherModal("⚠️ Dietary Validation", enhancedMessage, conflictingIngredients);
                  }
            } catch (error) {
                console.error('Validation error:', error);
            }
        }


        // Dynamic contextual messaging system - NEW CODE
        let messageTemplates = {};
        let userSelections = {
            cuisine: '',
            dishType: '',
            dietaryPreferences: [],
            hasIngredients: false
        };


        function showEnhancedKosherModal(title, msg, conflictingIngredients = []) {
            document.getElementById("kosherModalTitle").textContent = title;
            
            // Check if we have grouped conflicts for enhanced display
            const hasGroupedConflicts = window.activeConflicts && typeof window.activeConflicts === 'object' && !Array.isArray(window.activeConflicts);
            
            // Enhanced message display with per-ingredient controls if we have grouped conflicts
            if (hasGroupedConflicts && conflictingIngredients.length > 0) {
                let enhancedHTML = '<div style="max-height: 300px; overflow-y: auto;">';
                
                // Add each dietary type's conflicts
                Object.keys(window.activeConflicts).forEach(dietaryType => {
                    const conflicts = window.activeConflicts[dietaryType].filter(c => c.name); // Only show conflicts with ingredients
                    if (conflicts.length > 0) {
                        const typeLabel = dietaryType === 'vegetarian' ? '🌱 Vegetarian' : dietaryType;
                        enhancedHTML += `<div style="margin-bottom: 15px;"><strong>${typeLabel} conflicts:</strong><ul style="margin: 5px 0;">`;
                        conflicts.forEach(conflict => {
                            enhancedHTML += `<li>${conflict.name}</li>`;
                        });
                        enhancedHTML += '</ul></div>';
                        }
                        });

                        enhancedHTML += '</div><p style="margin-top: 10px; font-style: italic; color: #666;">These items conflict with your dietary preferences. Choose to keep or remove them.</p>';
                        document.getElementById("kosherModalMsg").innerHTML = enhancedHTML;
            } else {
                document.getElementById("kosherModalMsg").innerHTML = msg;
            }
            
            // Create button container
            const modalFooter = document.querySelector('#kosherModal .bg-white');
            const existingButton = document.getElementById('closeKosherModal');
            
            // Remove existing button if it exists
            if (existingButton) {
                existingButton.remove();
            }
            
            // Create new button container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'flex gap-3 mt-6';

            // Determine button text based on number of conflicts
            const keepButtonText = conflictingIngredients.length > 1 
                ? `Keep All (${conflictingIngredients.length} items)` 
                : 'Keep Anyway';

            buttonContainer.innerHTML = `
                ${conflictingIngredients.length > 0 ? `
                    <button id="keepAnywayBtn" 
                            class="bg-gray-500 text-white px-4 py-2 rounded shadow hover:bg-gray-600 flex-1 font-bold">
                        ${keepButtonText}
                    </button>
                ` : ''}
                <button id="closeKosherModalNew" 
                        class="bg-green-700 text-white px-4 py-2 rounded shadow hover:bg-green-800 flex-1 font-bold">
                    Remove Conflicts
                </button>
            `;
            
            modalFooter.appendChild(buttonContainer);
            
            // Show modal
            document.getElementById("kosherModal").classList.remove("hidden");
            
            // Event handlers
            document.getElementById("closeKosherModalNew").onclick = () => {
                // "Remove Conflicts" button - actually remove the conflicting ingredients
                if (conflictingIngredients.length > 0) {
                    // Remove each conflicting ingredient from selection
                    conflictingIngredients.forEach(ingredientName => {
                        // Remove from selectedIngredients array
                        const index = selectedIngredients.indexOf(ingredientName);
                        if (index > -1) {
                            selectedIngredients.splice(index, 1);
                        }
                        
                        // Remove visual selection in modal
                        const ingredientItems = document.querySelectorAll(`.ingredient-item[data-ingredient="${ingredientName}"]`);
                        ingredientItems.forEach(item => {
                            item.classList.remove('selected');
                        });
                    });
                    
                    // Update tab badges
                    updateTabBadges();
                }
                
                // Clear active conflicts
                window.activeConflicts = {};
                document.getElementById("kosherModal").classList.add("hidden");
                buttonContainer.remove();
            };
            
            if (conflictingIngredients.length > 0) {
                document.getElementById("keepAnywayBtn").onclick = () => {
                    // Restore conflicting ingredients to both array AND visual interface
                    conflictingIngredients.forEach(ingredient => {
                        if (!selectedIngredients.includes(ingredient)) {
                            selectedIngredients.push(ingredient);
                            
                            // Restore visual selection in modal
                            const ingredientItems = document.querySelectorAll(`.ingredient-item[data-ingredient="${ingredient}"]`);
                            ingredientItems.forEach(item => {
                                item.classList.add('selected');
                            });
                        }
                    });
                    updateTabBadges();
                    document.getElementById("kosherModal").classList.add("hidden");
                    buttonContainer.remove();
                };
            }
        }


        // Load message templates from same endpoint as ingredients
        async function loadMessageTemplates() {
            try {
                console.log('Loading message templates from ingredients endpoint...');
                const response = await fetch('/ingredients.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                // Templates are embedded in the response or we use fallback
                messageTemplates = data.message_templates || {
                    "cuisine_templates": [
                        "{cuisine} cuisine! You have excellent taste - these flavors never disappoint!",
                        "Wonderful choice! {cuisine} cooking brings such amazing variety.",
                        "{cuisine} cuisine - get ready for some incredible flavors!"
                    ],
                    "combination_templates": [
                        "Perfect match! {cuisine} {dishtype} is a wonderful combination.",
                        "Excellent choice! {cuisine} {dishtype} brings together amazing flavors."
                    ],
                    "ingredient_encouragement": [
                        "Nice ingredient choices! Those would work beautifully together.",
                        "I can already imagine a delicious recipe with those ingredients!"
                    ]
                };
                console.log('Loaded message templates');
            } catch (error) {
                console.error('Error loading message templates:', error);
            }
        }

        // Generate intelligent, compact ingredient confirmation messages
        function generateIntelligentIngredientMessage() {
            const cuisine = userSelections.cuisine;
            const dishType = userSelections.dishType;
            
            // Compact ingredient list (first 3 max to save space)
            const ingredientList = selectedIngredients.length > 3 
                ? `${selectedIngredients.slice(0, 3).join(', ')} + ${selectedIngredients.length - 3} more`
                : selectedIngredients.join(', ');
            
            let message = '';
            
            if (cuisine && dishType) {
                // Context-aware messages for known combinations
                message = `🔥 ${ingredientList} for ${cuisine} ${dishType.toLowerCase()}? Perfect choice! Those flavors will be incredible together.`;
            } else if (cuisine) {
                message = `✨ Great ${cuisine} ingredients: ${ingredientList}! I can already imagine the amazing flavors.`;
            } else if (dishType) {
                message = `👌 ${ingredientList} for ${dishType.toLowerCase()}? Excellent combination - this will be delicious!`;
            } else {
                message = `🌟 ${ingredientList} - fantastic ingredients! These will work beautifully together.`;
            }
            
            addMessage(message, 'bot');
        }

        // Generate dynamic message using templates
        function generateMessage(template, cuisine = '', dishType = '') {
            return template
                .replace('{cuisine}', cuisine.charAt(0).toUpperCase() + cuisine.slice(1))
                .replace('{dishtype}', dishType.toLowerCase());
        }

        // Get random template and generate message
        function getRandomDynamicMessage(templates, cuisine = '', dishType = '') {
            if (!templates || templates.length === 0) return null;
            const template = templates[Math.floor(Math.random() * templates.length)];
            return generateMessage(template, cuisine, dishType);
        }

        // Send contextual message
        function sendContextualMessage(message) {
            if (message) {
                setTimeout(() => {
                    addMessage(message, 'bot');
                }, 800);
            }
        }

        // Handle cuisine selection - DYNAMIC
        function handleCuisineSelection(cuisine) {
            userSelections.cuisine = cuisine;
            const message = `${cuisine.charAt(0).toUpperCase() + cuisine.slice(1)} cuisine! Excellent choice - these flavors never disappoint.`;
            sendContextualMessage(message);
        }

        // Handle dish type selection - DYNAMIC  
        function handleDishTypeSelection(dishType) {
            userSelections.dishType = dishType;
            
            let message;
            if (userSelections.cuisine) {
                message = `Perfect combination! ${userSelections.cuisine.charAt(0).toUpperCase() + userSelections.cuisine.slice(1)} ${dishType.toLowerCase()} brings together amazing flavors.`;
            } else {
                message = `${dishType} is a wonderful choice! Perfect for bringing out great flavors.`;
            }
            sendContextualMessage(message);
        }

        // Handle dietary preference selection
        function handleDietarySelection(preference) {
            if (!userSelections.dietaryPreferences.includes(preference)) {
                userSelections.dietaryPreferences.push(preference);
                const dietaryMessages = messageTemplates.dietary_templates?.[preference.toLowerCase()];
                const message = getRandomDynamicMessage(dietaryMessages);
                sendContextualMessage(message);
            }
        }

        // Handle ingredient selection
        function handleIngredientSelection() {
            if (!userSelections.hasIngredients && selectedIngredients.length > 0) {
                userSelections.hasIngredients = true;
                const message = getRandomDynamicMessage(messageTemplates.ingredient_encouragement);
                sendContextualMessage(message);
            }
        }

        // Load ingredients from JSON
        async function loadIngredients() {
            try {
                const response = await fetch('/ingredients.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                ingredientsData = await response.json();
                console.log('Loaded ingredients data:', ingredientsData);
                populateIngredientsModal();
                populateDropdowns();
            } catch (error) {
                console.error('Error loading ingredients:', error);
                alert('Failed to load ingredients. Please refresh the page.');
            }
        }

        // Global variables for tabbed ingredients
        let ingredientsByTab = {};
        let currentActiveTab = '';

        // Populate ingredients modal with tabs
        function populateIngredientsModal() {
            const ingredientTabs = document.getElementById('ingredientTabs');
            const ingredientTabContent = document.getElementById('ingredientTabContent');
            
            ingredientTabs.innerHTML = '';
            ingredientTabContent.innerHTML = '';
            ingredientsByTab = {};
            
            // Group ingredients by type for tabs
            ingredientsData.forEach(ingredient => {
                const type = ingredient.type || 'other';
                let tabName = type.charAt(0).toUpperCase() + type.slice(1);
                
                // Smart pluralization - don't add 's' if already ends in 's'
                if (!tabName.endsWith('s')) {
                    tabName += 's';
                }
                
                if (!ingredientsByTab[tabName]) {
                    ingredientsByTab[tabName] = [];
                }
                ingredientsByTab[tabName].push(ingredient.name);
            });
            
            // Create tabs
            Object.keys(ingredientsByTab).forEach((tabName, index) => {
                const tab = document.createElement('div');
                tab.className = 'ingredient-tab';
                tab.dataset.tab = tabName;
                
                const badge = document.createElement('span');
                badge.className = 'ingredient-tab-badge';
                badge.textContent = '0';
                
                tab.innerHTML = tabName;
                tab.appendChild(badge);
                
                tab.addEventListener('click', () => switchTab(tabName));
                ingredientTabs.appendChild(tab);
                
                // Set first tab as active
                if (index === 0) {
                    currentActiveTab = tabName;
                    tab.classList.add('active');
                }
            });
            
            // Show first tab content
            if (currentActiveTab) {
                showTabContent(currentActiveTab);
            }
        }

        // Switch to a different tab
        function switchTab(tabName) {
            // Update tab visual state
            document.querySelectorAll('.ingredient-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update current tab and show content
            currentActiveTab = tabName;
            showTabContent(tabName);
        }

        // Show content for the active tab
        function showTabContent(tabName) {
            const ingredientTabContent = document.getElementById('ingredientTabContent');
            ingredientTabContent.innerHTML = '';
            
            const ingredients = ingredientsByTab[tabName] || [];
            
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'tab-category';
            
            const ingredientGrid = document.createElement('div');
            ingredientGrid.className = 'ingredient-grid';
            
            ingredients.forEach(ingredient => {
                    const ingredientItem = document.createElement('div');
                    ingredientItem.className = 'ingredient-item';
                    ingredientItem.textContent = ingredient;
                    ingredientItem.dataset.ingredient = ingredient;
                    
                    // Restore selected state if ingredient was previously selected
                    if (selectedIngredients.includes(ingredient)) {
                        ingredientItem.classList.add('selected');
                    }
                    
                    ingredientItem.addEventListener('click', () => {
                        toggleIngredient(ingredientItem, ingredient);
                    });
                    
                    ingredientGrid.appendChild(ingredientItem);
                });
                
                categoryDiv.appendChild(ingredientGrid);
                ingredientTabContent.appendChild(categoryDiv);
        }

        // Update tab badges with selection counts
        function updateTabBadges() {
            Object.keys(ingredientsByTab).forEach(tabName => {
                const tab = document.querySelector(`[data-tab="${tabName}"]`);
                const badge = tab.querySelector('.ingredient-tab-badge');
                
                const tabIngredients = ingredientsByTab[tabName];
                const selectedCount = selectedIngredients.filter(ingredient => 
                    tabIngredients.includes(ingredient)
                ).length;
                
                badge.textContent = selectedCount;
                badge.style.display = selectedCount > 0 ? 'inline' : 'none';
            });
        }

        // Toggle ingredient selection
        function toggleIngredient(element, ingredient) {
            if (selectedIngredients.includes(ingredient)) {
                selectedIngredients = selectedIngredients.filter(item => item !== ingredient);
                element.classList.remove('selected');
            } else {
                selectedIngredients.push(ingredient);
                element.classList.add('selected');
            }
            
            // Update tab badges after selection change
            updateTabBadges();
        }

        // Populate dish type and cuisine dropdowns
        function populateDropdowns() {
            // Extract unique dish types from ingredients array
            const dishTypes = ['Baked', 'Curry', 'Dessert', 'Pasta', 'Salad', 'Skewers', 'Soup', 'Stir-fry'];
            const dishTypeSelect = document.getElementById('dishTypeSelect');
            dishTypes.forEach(dishType => {
                const option = document.createElement('option');
                option.value = dishType;  // Keep the capitalized value
                option.textContent = dishType.charAt(0).toUpperCase() + dishType.slice(1);
                dishTypeSelect.appendChild(option);
            });

            // Extract unique cuisines from ingredients array
            const allCuisines = ingredientsData.flatMap(ing => ing.cuisine || []);
            const uniqueCuisines = [...new Set(allCuisines)];
            const cuisineSelect = document.getElementById('cuisineSelect');
            uniqueCuisines.forEach(cuisine => {
                const option = document.createElement('option');
                option.value = cuisine.toLowerCase();
                option.textContent = cuisine.charAt(0).toUpperCase() + cuisine.slice(1);
                cuisineSelect.appendChild(option);
            });
        }

        // Modal event listeners
        selectIngredientsBtn.addEventListener('click', () => {
            ingredientModal.classList.add('show');
        });

        modalClose.addEventListener('click', () => {
            ingredientModal.classList.remove('show');
        });

        ingredientModal.addEventListener('click', (e) => {
            if (e.target === ingredientModal) {
                ingredientModal.classList.remove('show');
            }
        });

        clearSelection.addEventListener('click', () => {
            selectedIngredients = [];
            document.querySelectorAll('.ingredient-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
            // Update tab badges after clearing
            updateTabBadges();
        });

        confirmSelection.addEventListener('click', () => {
            if (selectedIngredients.length > 0) {
                generateIntelligentIngredientMessage();
                // Validate dietary preferences after ingredient selection
                setTimeout(() => validateCurrentSelections(), 100);
            }
            ingredientModal.classList.remove('show');
        });

        // Auto-resize textarea
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 80) + 'px';
        });

        // Send message function
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message
            addMessage(message, 'user');
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // Show typing indicator
            showTypingIndicator();
            
            // Disable send button
            chatSendBtn.disabled = true;
            sendIcon.className = 'fas fa-spinner fa-spin';

            try {
                // Call REAL chat API with business protection
                const response = await fetch('http://localhost:3000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                // Add bot response
                addMessage(data.reply || 'Sorry, I encountered an error. Please try again.', 'bot');
                
            } catch (error) {
                console.error('Chat error:', error);
                addMessage('Sorry, I encountered an error. Please try again.', 'bot');
            } finally {
                hideTypingIndicator();
                chatSendBtn.disabled = false;
                sendIcon.className = 'fas fa-paper-plane';
            }
        }

        // Add message to chat
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            if (type === 'bot') {
                contentDiv.innerHTML = text; // Just show the text with its emoji
            } else {
                contentDiv.textContent = text;
            }
            
            // Clear ALL previous messages and ensure clean slate
            chatMessages.innerHTML = '';
            // Remove any typing indicators that might be lingering
            const existingTyping = document.getElementById('typingIndicator');
            if (existingTyping) {
                existingTyping.remove();
            }
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);

        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'typing-indicator';
            indicatorDiv.innerHTML = `
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span style="color: var(--gray); font-size: 0.75rem; font-style: italic;">RecipeGen is thinking...</span>
            `;
            
            typingDiv.appendChild(indicatorDiv);
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Event listeners
        chatSendBtn.addEventListener('click', sendMessage);
        
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Interactive elements - now with validation
        document.querySelectorAll('.dietary-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                tag.classList.toggle('active');
                console.log('Dietary tag clicked:', tag.textContent.trim(), 'Active:', tag.classList.contains('active'));
                console.log('All active tags:', Array.from(document.querySelectorAll('.dietary-tag.active')).map(t => t.textContent.trim()));
                // Trigger validation when dietary preferences change
                validateCurrentSelections();
            });
        });

        // Generate button - shows chef selection modal
        document.querySelector('.generate-btn').addEventListener('click', async () => {
            const dishType = document.getElementById('dishTypeSelect').value;
            const cuisine = document.getElementById('cuisineSelect').value;
            
            if (!dishType || !cuisine) {
                showErrorModal('Missing Selection', 'Please select both dish type and cuisine before generating your recipe.');
                return;
            }
            
            // Store form data for after chef selection
            window.pendingGeneration = {
                dishType: dishType,
                cuisine: cuisine,
                selectedDietaryTags: Array.from(document.querySelectorAll('.dietary-tag.active')).map(tag => tag.textContent.trim())
            };
            
            // Show chef selection modal
            document.getElementById('chefSelectionModal').classList.add('show');
        });

        // Video status polling function
        async function pollVideoStatus() {
            const pollInterval = setInterval(async () => {
                try {
                    const statusResponse = await fetch(`/check_video_status/${window.currentTaskId}`);
                    const status = await statusResponse.json();
                    
                    if (status.ready || status.status === 'completed') {
                        clearInterval(pollInterval);
                        
                        // Video is ready - show unlock interface
                        let videoSrc = '';
                        if (status.local_path) {
                            const filename = status.local_path.split('\\').pop().split('/').pop();
                            videoSrc = `/output/${filename}`;
                        } else if (status.video_url) {
                            videoSrc = status.video_url;
                        }
                        
                        document.querySelector('.info-card').innerHTML = `
                            <div class="text-center py-6">
                                <h3 class="text-2xl font-bold mb-4">${window.currentRecipeTitle}</h3>
                                <div class="mb-4 p-4 bg-green-100 rounded-lg">
                                    <div class="text-lg font-bold mb-2 text-green-700">🎬 Your recipe trailer is ready!</div>
                                    <video controls class="w-full rounded shadow mb-4" src="${videoSrc}">
                                        Your browser does not support the video tag.
                                    </video>
                                </div>
                                <div class="p-4 bg-yellow-100 rounded-lg">
                                    <div class="text-2xl font-bold text-green-700 mb-2">${window.currentRecipePrice}</div>
                                    <div class="text-sm text-gray-700 mb-4">Full recipe with detailed steps, techniques & chef secrets</div>
                                    <button onclick="unlockRecipe()" 
                                            class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-all">
                                        🔓 Unlock Full Recipe
                                    </button>
                                </div>
                            </div>
                        `;
                        
                    } else if (status.status === 'failed') {
                        clearInterval(pollInterval);
                        
                        // Video failed, but still allow recipe unlock
                        document.querySelector('.info-card').innerHTML = `
                            <div class="text-center py-6">
                                <h3 class="text-2xl font-bold mb-4">${window.currentRecipeTitle}</h3>
                                <div class="p-4 bg-yellow-100 rounded-lg">
                                    <div class="text-sm text-gray-600 mb-2">⚠️ Video generation unavailable</div>
                                    <div class="text-2xl font-bold text-green-700 mb-2">${window.currentRecipePrice}</div>
                                    <div class="text-sm text-gray-700 mb-4">Full recipe with detailed steps & techniques</div>
                                    <button onclick="unlockRecipe()" 
                                            class="bg-green-600 text-white px-6 py-3 rounded-lg font-bold text-lg hover:bg-green-700 transition-all">
                                        🔓 Unlock Full Recipe
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                    // If status is still 'processing' or 'queued', keep polling
                    
                } catch (error) {
                    console.error('Status polling error:', error);
                    clearInterval(pollInterval);
                    
                    document.querySelector('.info-card').innerHTML = `
                        <div class="text-center py-6">
                            <div class="text-xl font-bold text-red-600 mb-4">❌ Status check failed</div>
                            <p class="text-gray-600">Unable to check video status. Please try generating again.</p>
                        </div>
                    `;
                }
            }, 3000); // Poll every 3 seconds
        }

        // Recipe unlock function
        async function unlockRecipe() {
            // Show unlocking state
            document.querySelector('.info-card').innerHTML = `
                <div class="text-center py-8">
                    <div class="text-xl font-bold mb-4 text-green-700">🔓 Unlocking your recipe...</div>
                    <div class="loader-dots text-gray-500">Processing payment</div>
                </div>
            `;
            
            try {
                const response = await fetch(`/get_full_recipe/${window.currentRecipeId}`);
                const data = await response.json();
                
                if (data.success) {
                    displayFullRecipe(data.recipe);
                } else {
                    document.querySelector('.info-card').innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-xl font-bold text-red-600 mb-4">❌ Recipe not found</div>
                            <p class="text-gray-600">${data.error || 'Unable to unlock recipe. Please try again.'}</p>
                            <button onclick="location.reload()" 
                                    class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Unlock error:', error);
                document.querySelector('.info-card').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-xl font-bold text-red-600 mb-4">❌ Connection error</div>
                        <p class="text-gray-600">Failed to unlock recipe. Please check your connection and try again.</p>
                        <button onclick="location.reload()" 
                                class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                            Refresh Page
                        </button>
                    </div>
                `;
            }
        }

        // Chef selection functions
        function selectChef(chefType) {
            // Store selected chef
            window.selectedChef = chefType;
            
            // Hide chef selection modal
            document.getElementById('chefSelectionModal').classList.remove('show');
            
            console.log('👨‍🍳 Chef selected:', chefType);
            
            // Start recipe generation with selected chef
            generateRecipeWithChef();
        }

        async function generateRecipeWithChef() {
            const { dishType, cuisine, selectedDietaryTags } = window.pendingGeneration;

            // Map frontend display names to backend dish types
            const dishTypeMapping = {
                'Baked': 'baked-dish',
                'Curry': 'curry', 
                'Dessert': 'dessert',
                'Grilled': 'grilled',
                'Pasta': 'pasta',
                'Salad': 'salad', 
                'Skewers': 'skewers',
                'Soup': 'soup',
                'Stir-fry': 'stir-fry'
            };

            const backendDishType = dishTypeMapping[dishType] || dishType.toLowerCase();

            // Add these debug lines:
            console.log('🔍 Frontend Debug:');
            console.log('Original dishType:', dishType);
            console.log('Mapped backendDishType:', backendDishType);
            console.log('dishTypeMapping:', dishTypeMapping);
            
            // Show progressive loading in right panel
            document.querySelector('.info-card').innerHTML = `
                <div id="recipeProgress" class="text-center py-8" style="display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%;">
                    <div id="progressText" class="text-2xl font-bold mb-4 text-gray-700">🔍 Searching for your perfect recipe...</div>
                    <div class="loader-dots text-lg text-gray-500">Finding the best match</div>
                </div>
            `;
            
            try {
                const response = await fetch('/generate_recipe_instant', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dish_type: backendDishType,
                        cuisine: cuisine,
                        ingredients: selectedIngredients.map(name => {
                            const ingredient = ingredientsData.find(ing => ing.name === name);
                            return ingredient ? ingredient.slug : name.toLowerCase().replace(/\s+/g, '-');
                        }),
                        dietary_preferences: selectedDietaryTags,
                        chef_preference: window.selectedChef
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update to "Recipe found" state
                    document.getElementById('progressText').innerHTML = '✅ Recipe found! Creating your 8-second recipe trailer...';
                    document.querySelector('.loader-dots').innerHTML = 'Watch the highlights, then unlock the full recipe!';
                    // Ensure parent container stays centered
                    document.getElementById('recipeProgress').style.cssText = 'display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; text-align: center; padding: 2rem;';
                    
                    // Store recipe data for later unlock
                    window.currentRecipeId = data.recipe_id;
                    window.currentTaskId = data.task_id;
                    window.currentRecipeTitle = data.recipe_title || data.teaser;
                    window.currentRecipePrice = data.price;
                    
                    // Start polling for video completion
                    pollVideoStatus();
                } else {
                    document.querySelector('.info-card').innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-xl font-bold text-red-600 mb-4">❌ Recipe generation failed</div>
                            <p class="text-gray-600">${data.error || 'Please try again with different ingredients.'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Generation error:', error);
                document.querySelector('.info-card').innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-xl font-bold text-red-600 mb-4">❌ Connection error</div>
                        <p class="text-gray-600">Failed to generate recipe. Please try again.</p>
                    </div>
                `;
            }
        }

        // Chef modal close handlers
        document.getElementById('chefModalClose').addEventListener('click', () => {
            document.getElementById('chefSelectionModal').classList.remove('show');
        });

        document.getElementById('chefSelectionModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('chefSelectionModal')) {
                document.getElementById('chefSelectionModal').classList.remove('show');
            }
        });

        // Cuisine selection handler - NEW
        document.getElementById('cuisineSelect').addEventListener('change', function() {
            const cuisine = this.value;
            if (cuisine) {
                handleCuisineSelection(cuisine);
                // Update logo colors based on cuisine selection
                updateLogoCuisine(cuisine);
            }
        });

        // Update logo colors based on selected cuisine
        function updateLogoCuisine(cuisine) {
            const logo = document.getElementById('dynamicLogo');
            
            // Remove any existing cuisine classes
            logo.className = logo.className.replace(/cuisine-\w+/g, '');
            
            // Add the new cuisine class
            if (cuisine) {
                console.log('Selected cuisine:', cuisine);
                logo.classList.add(`cuisine-${cuisine.toLowerCase()}`);
            }
        }

        // Dish type selection handler - NEW
        document.getElementById('dishTypeSelect').addEventListener('change', function() {
            const dishType = this.value;
            if (dishType) {
                handleDishTypeSelection(dishType);
            }
        });

        // Initialize ingredients when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, calling loadIngredients...');
            loadIngredients();
            loadMessageTemplates();
            
            // Set up error modal close handler AFTER DOM is loaded
            document.getElementById("closeErrorModal").onclick = () => {
                document.getElementById("errorModal").classList.add("hidden");
            };
        });


        document.getElementById("closeKosherModal").onclick = () => {
                document.getElementById("kosherModal").classList.add("hidden");
            };

        function displayFullRecipe(recipe) {
            const ingredients = recipe.all_ingredients || recipe.ingredients || [];
            
            const recipeHTML = `
              <div class="p-6 bg-white rounded-lg shadow-lg border-2 border-green-500" style="margin-top: 0; align-self: flex-start;">
                <div class="mb-4 p-3 bg-green-100 rounded">
                  <span class="text-green-700 font-bold">✅ Recipe Unlocked!</span>
                </div>
                
                <h2 class="text-3xl font-bold mb-4">${recipe.title}</h2>
                
              <div class="flex gap-4 text-gray-600 mb-6 justify-center">
                <span>🍽️ ${recipe.cuisine}</span>
                <span>👥 ${recipe.servings || 4} servings</span>
                <span>⏱️ ${((parseInt(recipe.prep_time) || 0) + (parseInt(recipe.cook_time) || 0)) || 35} minutes</span>
              </div>
                
                <div class="grid md:grid-cols-2 gap-6">
                 <div>
                   <h3 class="text-xl font-bold mb-3 text-green-700">📝 Ingredients:</h3>
                   <ul class="space-y-2">
                     ${ingredients.map(ing => `
                       <li class="flex items-start">
                         <span class="text-green-500 mr-2">•</span>
                         <span>${ing.amount || ''} ${ing.name || ing.item || ing}</span>
                       </li>
                     `).join('')}
                   </ul>
                 </div>
                 
                  <div>
                    <h3 class="text-xl font-bold mb-3 text-green-700">👨‍🍳 Instructions:</h3>
                      <ol class="space-y-3">
                      ${(recipe.steps || recipe.instructions || []).map((step, idx) => `
                        <li style="display: flex; gap: 12px; align-items: baseline;">
                          <span style="background: blue; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;">
                            ${idx + 1}
                          </span>
                          <div style="line-height: 1.5; text-align: left;">${step.instruction || step.text || step}</div>
                        </li>
                      `).join('')}
                    </ol>
                  </div>
               </div>
               
               <div class="mt-6 p-4 bg-gray-100 rounded">
                 <h4 class="font-bold mb-2">💡 Chef's Tips:</h4>
                 <p class="text-gray-700">${(recipe.chef_secrets && recipe.chef_secrets.trim()) || (recipe.chef_notes && recipe.chef_notes.trim()) || 'Enjoy your homemade ' + recipe.title + '!'}</p>
               </div>
                <div class="mt-4 flex justify-center gap-4">
                  <button onclick="window.print()" 
                          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    🖨️ Print Recipe
                  </button>
                  <button onclick="saveAsPDF()" 
                          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 flex items-center gap-2">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIGZpbGw9IndoaXRlIiB2aWV3Qm94PSIwIDAgMjQgMjQiPjxwYXRoIGQ9Ik0xOS41IDExSDQuNVYxM0gxOS41VjExWk0yMSA5SDE5VjdDMTkgNS44OSAxOC4xIDUgMTcgNUg3QzUuODkgNSA1IDUuODkgNSA3VjlIM1YxNUMzIDE2LjEgMy44OSAxNyA1IDE3SDdWMTlDNyAyMC4xIDcuODkgMjEgOSAyMUgxNUMxNi4xIDIxIDE3IDIwLjExIDE3IDE5VjE3SDE5QzIwLjExIDE3IDIxIDE2LjEgMjEgMTVWOVpNMTcgN1Y5SDdWN0gxN1pNMTUgMTlIOVYxNUgxNVYxOVoiLz48L3N2Zz4=" alt="PDF" class="w-4 h-4">
                    Save as PDF
                  </button>
                </div>
             </div>
           `;
           

            document.querySelector('.info-card').innerHTML = recipeHTML;
            document.querySelector('.info-card').style.justifyContent = 'flex-start';
            document.querySelector('.info-card').style.alignItems = 'stretch';
       }

        async function saveAsPDF() {
          const { jsPDF } = window.jspdf;
          
          // Get recipe content
          const recipeElement = document.querySelector('.info-card .p-6');
          
          // Hide buttons temporarily
          const buttons = recipeElement.querySelector('.mt-4');
          const originalDisplay = buttons.style.display;
          buttons.style.display = 'none';
          
          try {
            // Convert to canvas
            const canvas = await html2canvas(recipeElement, {
              scale: 2,
              useCORS: true,
              logging: false
            });
            
            // Create PDF
            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgData = canvas.toDataURL('image/png');
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
            
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            
            // Download PDF
            const fileName = document.querySelector('.info-card h2').textContent.replace(/[^a-zA-Z0-9]/g, '_') + '.pdf';
            pdf.save(fileName);
            
          } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
          } finally {
            // Restore buttons
            buttons.style.display = originalDisplay;
          }
        }

        // Show elegant error modal instead of ugly alert
        function showErrorModal(title, message) {
            document.getElementById("errorModalTitle").textContent = title;
            document.getElementById("errorModalMsg").textContent = message;
            document.getElementById("errorModal").classList.remove("hidden");
        }


   </script>

<!-- Error Modal -->
<div id="errorModal"
     class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
  <div class="bg-white rounded-lg shadow-2xl p-6 max-w-lg w-full border-2 border-red-500">
    <div id="errorModalTitle" class="text-2xl font-bold text-red-700 mb-2"></div>
    <div id="errorModalMsg" class="text-gray-700 whitespace-pre-line mb-6"></div>
    <button id="closeErrorModal"
            class="bg-red-600 text-white px-5 py-2 rounded shadow hover:bg-red-700 w-full font-bold text-lg">
      OK
    </button>
  </div>
</div>


</body>
</html>