from flask import Flask, jsonify, request, send_from_directory, session
from flask_cors import CORS
from flask_session import Session
import json
import os
import openai

# âœ… LEGACY IMPORT VALIDATION
assert openai.__version__.startswith("0.28"), f"WRONG openai VERSION LOADED: {openai.__version__}"

from dotenv import load_dotenv
import sys

print("âœ… main.py loaded and running")

# === Dual-path ENV Loader ===
abs_path = "D:\\RecipeGen\\Tehomia-chatgpt-diagnostics-remix\\.env"
if os.path.exists(abs_path):
    load_dotenv(dotenv_path=abs_path)
    print("âœ… Loaded .env from ABSOLUTE path (development)")
elif os.path.exists(".env"):
    load_dotenv()
    print("âœ… Loaded .env from RELATIVE path (production-ready)")
else:
    print("âŒ No .env file found â€” check pathing before deployment.")

print("âœ… Loaded API KEY (active load):", os.getenv("OPENAI_API_KEY"))

# ğŸ”½ ENVIRONMENT DIAGNOSTICS
print("âš™ï¸ ENVIRONMENT DIAGNOSTIC")
print(f"Python Executable : {sys.executable}")
print(f"Python Version    : {sys.version}")
print(f"OpenAI Version    : {openai.__version__}")
print(f"OpenAI Path       : {openai.__file__}")
print(f"ENV Variable OPENAI_API_KEY: {os.getenv('OPENAI_API_KEY')}")

# === Assign Key ===
openai.api_key = os.getenv("OPENAI_API_KEY")  # âœ… LEGACY KEY ASSIGNMENT

app = Flask(__name__, static_url_path='/static', static_folder='static')
app.secret_key = 'supersecretkey'
app.config['SESSION_TYPE'] = 'filesystem'
Session(app)
CORS(app)

# âœ… Blueprint registration
from video_routes import video_bp
app.register_blueprint(video_bp)

# === Load Data ===
with open('data/recipes.json') as f:
    recipes = json.load(f)

with open('data/history.json') as f:
    history = json.load(f)

# === Routes ===

@app.route('/categories', methods=['GET'])
def get_categories():
    categories = list({r['category'] for r in recipes})
    return jsonify(categories)

@app.route('/recipes', methods=['GET'])
def get_recipes():
    category = request.args.get('category')
    if category:
        filtered = [r for r in recipes if r['category'].lower() == category.lower()]
        return jsonify(filtered)
    return jsonify(recipes)

@app.route('/recipes/<int:recipe_id>', methods=['GET'])
def get_recipe(recipe_id):
    for r in recipes:
        if r['id'] == recipe_id:
            return jsonify(r)
    return jsonify({'error': 'Recipe not found'}), 404

@app.route('/recipes/<int:recipe_id>/generate', methods=['POST'])
def generate_recipe(recipe_id):
    for r in recipes:
        if r['id'] == recipe_id:
            entry = {'recipe_id': recipe_id, 'title': r['title']}
            history.append(entry)
            with open('data/history.json', 'w') as f:
                json.dump(history, f, indent=2)
            return jsonify({'instructions': 'Step-by-step instructions will appear here.'})
    return jsonify({'error': 'Recipe not found'}), 404

@app.route('/history', methods=['GET'])
def get_history():
    return jsonify(history)

@app.route('/login', methods=['POST'])
def login():
    credentials = request.json
    if credentials.get('username') == 'admin' and credentials.get('password') == 'password123':
        session['user'] = 'admin'
        return jsonify({'status': 'success'})
    return jsonify({'status': 'failure'}), 401

@app.route("/ingredients", methods=["GET"])
def get_ingredients():
    try:
        with open("data/ingredients.json", "r", encoding="utf-8") as f:
            ingredients = json.load(f)
        return jsonify(ingredients)
    except Exception as e:
        return jsonify({"error": "Unable to load ingredients", "details": str(e)}), 500

@app.route("/chat", methods=["POST"])
def chat():
    print("ğŸ”µ /chat route hit")

    # BULLETPROOF JSON
    data = request.get_json(force=True)
    if not data or "message" not in data:
        print("ğŸ”´ No message found in payload.")
        return jsonify({'error': 'Invalid request'}), 400

    user_message = data["message"].strip()
    print("ğŸŸ¢ User message:", user_message)

    # â”€â”€â”€ Intercept any â€œloginâ€ or â€œlog inâ€ question â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    text = user_message.lower()
    if "login" in text or "log in" in text:
        print("ğŸŸ¡ Intercepted login/log in question")
        return jsonify({
            'reply': (
                "To log in, click the â€œLoginâ€ link in the topâ€‘right navbar, "
                "enter your username and password, then hit Submit."
            )
        })

    # â”€â”€â”€ Intercept any admin/support/help inquiries â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    admin_keywords = ["administrator", "admin", "support", "help", "contact", "account", "password"]
    if any(kw in text for kw in admin_keywords):
        print("ğŸŸ¡ Intercepted administrative/support question")
        return jsonify({
            'reply': (
                "For siteâ€‘administration or support issues, please use the â€œContactâ€ "
                "link in the topâ€‘right navbar or email support@yourdomain.com."
            )
        })

    # ğŸ§  Otherwise call OpenAI
    try:
        resp = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "You are RecipeGen."},
                {"role": "user",   "content": user_message}
            ],
            max_tokens=150
        )
        ai_reply = resp.choices[0].message.content.strip()
        print("ğŸŸ£ AI reply:", ai_reply)
    except Exception as e:
        print("âŒ OpenAI error:", e)
        return jsonify({'error': 'Server error'}), 500

    # RETURN JSON
    return jsonify(reply=ai_reply)

@app.route('/ui')
def serve_ui():
    return send_from_directory('static', 'index.html')

@app.route('/')
def root():
    return send_from_directory('static', 'index.html')

# âœ… EXPORT FOR TESTING + CLI EXECUTION
if __name__ == "__main__":
    port = int(os.environ.get("PORT", 3000))
    app.run(host="0.0.0.0", port=port)
